#include "gtest/gtest.h"

#include "../src/PhoenixSketch/SDT.h"

TEST(Loop, InterruptInitializes){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    InterruptType i = GetInterrupt();
    EXPECT_EQ(i, iNONE);
} 

TEST(Loop, InterruptSet){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    SetInterrupt(iPTT_PRESSED);
    InterruptType i = GetInterrupt();
    EXPECT_EQ(i, iPTT_PRESSED);
} 

TEST(Loop, InterruptCleared){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    SetInterrupt(iPTT_PRESSED);
    ConsumeInterrupt();
    InterruptType i = GetInterrupt();
    EXPECT_EQ(i, iNONE);
}

TEST(Loop, PTTPressedTriggersModeStateChange){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_SSB_RECEIVE);
    SetInterrupt(iPTT_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_SSB_TRANSMIT);
}

TEST(Loop, PTTReleasedTriggersModeStateChange){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    modeSM.state_id = ModeSm_StateId_SSB_TRANSMIT;
    SetInterrupt(iPTT_RELEASED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_SSB_RECEIVE);
}

// Key1 pressed is interpreted as straight key when keyType is straight
TEST(Loop, KeyPressedInterpretedAsStraight){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    SetKeyType(KeyTypeId_Straight);
    SetInterrupt(iKEY1_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_CW_TRANSMIT_MARK);
}

// Key1 pressed is interpreted as dit key when keyType is keyer and flip = false
// and key2 pressed is interpreted as dah
TEST(Loop, KeyPressesInterpretedWhenKeyerAndFlipFalse){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    SetKeyType(KeyTypeId_Keyer);
    SetKey1Dit();
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    SetInterrupt(iKEY1_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_CW_TRANSMIT_DIT_MARK);
    ModeSm_start(&modeSM);
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    SetInterrupt(iKEY2_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_CW_TRANSMIT_DAH_MARK);
}


// Key1 pressed is interpreted as dah key when keyType is keyer and flip = true
// and key2 pressed is interpreted as dit
TEST(Loop, KeyPressesInterpretedWhenKeyerAndFlipTrue){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    SetKeyType(KeyTypeId_Keyer);
    SetKey1Dah();
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    SetInterrupt(iKEY1_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_CW_TRANSMIT_DAH_MARK);
    ModeSm_start(&modeSM);
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    SetInterrupt(iKEY2_PRESSED);
    ConsumeInterrupt();
    EXPECT_EQ(modeSM.state_id,ModeSm_StateId_CW_TRANSMIT_DIT_MARK);
}

TEST(Loop, UpdateAudioIOState){
    UISm_start(&uiSM);
    ModeSm_start(&modeSM);
    modeSM.state_id = ModeSm_StateId_CW_RECEIVE;
    UpdateAudioIOState();
    ModeSm_StateId prev = GetAudioPreviousState();
    EXPECT_EQ(prev, ModeSm_StateId_CW_RECEIVE);

    modeSM.state_id = ModeSm_StateId_SSB_RECEIVE;
    UpdateAudioIOState();
    prev = GetAudioPreviousState();
    EXPECT_EQ(prev, ModeSm_StateId_SSB_RECEIVE);
}
